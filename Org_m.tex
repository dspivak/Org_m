\documentclass[11pt, one side, article]{memoir}


\settrims{0pt}{0pt} % page and stock same size
\settypeblocksize{*}{33.5pc}{*} % {height}{width}{ratio}
\setlrmargins{*}{*}{1} % {spine}{edge}{ratio}
\setulmarginsandblock{.98in}{.98in}{*} % height of typeblock computed
\setheadfoot{\onelineskip}{2\onelineskip} % {headheight}{footskip}
\setheaderspaces{*}{1.5\onelineskip}{*} % {headdrop}{headsep}{ratio}
\checkandfixthelayout


\usepackage{amsthm}
\usepackage{mathtools}

\usepackage[inline]{enumitem}
\usepackage{ifthen}
\usepackage[utf8]{inputenc} %allows non-ascii in bib file
\usepackage{xcolor}

\usepackage[backend=biber, backref=true, maxbibnames = 10, style = alphabetic]{biblatex}
\usepackage[bookmarks=true, colorlinks=true, linkcolor=blue!50!black,
citecolor=orange!50!black, urlcolor=orange!50!black, pdfencoding=unicode]{hyperref}
\usepackage[capitalize]{cleveref}

\usepackage{tikz}

\usepackage{amssymb}
\usepackage{newpxtext}
\usepackage[varg,bigdelims]{newpxmath}
\usepackage{mathrsfs}
\usepackage{dutchcal}
\usepackage{mathalfa}
\usepackage{fontawesome}
\usepackage{ebproof}
\usepackage{stmaryrd}
\usepackage{ebproof}
\usepackage{graphicx}

% xcolor %
	\newcommand{\myred}[1]{{\color{red!60!black}#1}}
	\newcommand{\myyellow}[1]{{\color{yellow!60!black}#1}}
	\newcommand{\mygreen}[1]{{\color{green!40!black}#1}}

% cleveref %
  \newcommand{\creflastconjunction}{, and\nobreakspace} % serial comma
  \crefformat{enumi}{\card#2#1#3}
  \crefalias{chapter}{section}


% biblatex %
  \addbibresource{Library20240724.bib} 

% hyperref %
  \hypersetup{final}

% enumitem %
  \setlist{nosep}
  \setlistdepth{6}



% tikz %



  \usetikzlibrary{ 
  	cd,
  	math,
  	decorations.markings,
		decorations.pathreplacing,
  	positioning,
  	arrows.meta,
  	shapes,
		shadows,
		shadings,
  	calc,
  	fit,
  	quotes,
  	intersections,
    circuits,
    circuits.ee.IEC
  }
  
  \tikzset{
biml/.tip={Glyph[glyph math command=triangleleft, glyph length=.95ex]},
bimr/.tip={Glyph[glyph math command=triangleright, glyph length=.95ex]},
}

\tikzset{
	tick/.style={postaction={
  	decorate,
    decoration={markings, mark=at position 0.5 with
    	{\draw[-] (0,.4ex) -- (0,-.4ex);}}}
  }
} 
\tikzset{
	slash/.style={postaction={
  	decorate,
    decoration={markings, mark=at position 0.5 with
    	{\draw[-] (.3ex,.3ex) -- (-.3ex,-.3ex);}}}
  }
} 

\newcommand{\upp}{\begin{tikzcd}[row sep=6pt]~\\~\ar[u, bend left=50pt, looseness=1.3, start anchor=east, end anchor=east]\end{tikzcd}}

\newcommand{\bito}[1][]{
	\begin{tikzcd}[ampersand replacement=\&, cramped]\ar[r, biml-bimr, "#1"]\&~\end{tikzcd}  
}
\newcommand{\bifrom}[1][]{
	\begin{tikzcd}[ampersand replacement=\&, cramped]\ar[r, bimr-biml, "{#1}"]\&~\end{tikzcd}  
}
\newcommand{\bifromlong}[2][]{
	\begin{tikzcd}[ampersand replacement=\&, column sep=#2, cramped]\ar[r, bimr-biml, "#1"]\&~\end{tikzcd}  
}

% Adjunctions
\newcommand{\adj}[5][30pt]{%[size] Cat L, Left, Right, Cat R.
\begin{tikzcd}[ampersand replacement=\&, column sep=#1]
  #2\ar[r, shift left=7pt, "#3"]
  \ar[r, phantom, "\scriptstyle\Rightarrow"]\&
  #5\ar[l, shift left=7pt, "#4"]
\end{tikzcd}
}

\newcommand{\adjr}[5][30pt]{%[size] Cat R, Right, Left, Cat L.
\begin{tikzcd}[ampersand replacement=\&, column sep=#1]
  #2\ar[r, shift left=7pt, "#3"]\&
  #5\ar[l, shift left=7pt, "#4"]
  \ar[l, phantom, "\scriptstyle\Leftarrow"]
\end{tikzcd}
}

\newcommand{\xtickar}[1]{\begin{tikzcd}[baseline=-0.5ex,cramped,sep=small,ampersand 
replacement=\&]{}\ar[r,tick, "{#1}"]\&{}\end{tikzcd}}
\newcommand{\xslashar}[1]{\begin{tikzcd}[baseline=-0.5ex,cramped,sep=small,ampersand 
replacement=\&]{}\ar[r,tick, "{#1}"]\&{}\end{tikzcd}}



  
  % amsthm %
\theoremstyle{definition}
\newtheorem{definitionx}{Definition}[chapter]
\newtheorem{examplex}[definitionx]{Example}
\newtheorem{remarkx}[definitionx]{Remark}
\newtheorem{notation}[definitionx]{Notation}


\theoremstyle{plain}

\newtheorem{theorem}[definitionx]{Theorem}
\newtheorem{proposition}[definitionx]{Proposition}
\newtheorem{corollary}[definitionx]{Corollary}
\newtheorem{lemma}[definitionx]{Lemma}
\newtheorem{warning}[definitionx]{Warning}
\newtheorem*{theorem*}{Theorem}
\newtheorem*{proposition*}{Proposition}
\newtheorem*{corollary*}{Corollary}
\newtheorem*{lemma*}{Lemma}
\newtheorem*{warning*}{Warning}
%\theoremstyle{definition}
%\newtheorem{definition}[theorem]{Definition}
%\newtheorem{construction}[theorem]{Construction}

\newenvironment{example}
  {\pushQED{\qed}\renewcommand{\qedsymbol}{$\lozenge$}\examplex}
  {\popQED\endexamplex}
  
 \newenvironment{remark}
  {\pushQED{\qed}\renewcommand{\qedsymbol}{$\lozenge$}\remarkx}
  {\popQED\endremarkx}
  
  \newenvironment{definition}
  {\pushQED{\qed}\renewcommand{\qedsymbol}{$\lozenge$}\definitionx}
  {\popQED\enddefinitionx} 

    
%-------- Single symbols --------%
	
\DeclareSymbolFont{stmry}{U}{stmry}{m}{n}
\DeclareMathSymbol\fatsemi\mathop{stmry}{"23}

\DeclareFontFamily{U}{mathx}{\hyphenchar\font45}
\DeclareFontShape{U}{mathx}{m}{n}{
      <5> <6> <7> <8> <9> <10>
      <10.95> <12> <14.4> <17.28> <20.74> <24.88>
      mathx10
      }{}
\DeclareSymbolFont{mathx}{U}{mathx}{m}{n}
\DeclareFontSubstitution{U}{mathx}{m}{n}
\DeclareMathAccent{\widecheck}{0}{mathx}{"71}

\ExplSyntaxOn
\NewDocumentEnvironment{sequation}{O{\fontsize{15pt}{15pt}\selectfont
}b}
 {
  \yufip_sequation:nnn {equation}{#1}{#2}
 }{}
\NewDocumentEnvironment{sequation*}{O{\fontsize{16pt}{16pt}\selectfont
}b}
 {
  \yufip_sequation:nnn {equation*}{#1}{#2}
 }{}
\cs_new_protected:Nn \yufip_sequation:nnn
 {
  \begin{#1}
  \mbox{#2$\displaystyle#3$}
  \end{#1}
 }
\ExplSyntaxOff

%-------- Renewed commands --------%

\renewcommand{\ss}{\subseteq}

%-------- Other Macros --------%


\DeclarePairedDelimiter{\present}{\langle}{\rangle}
\DeclarePairedDelimiter{\copair}{[}{]}
\DeclarePairedDelimiter{\floor}{\lfloor}{\rfloor}
\DeclarePairedDelimiter{\ceil}{\lceil}{\rceil}
\DeclarePairedDelimiter{\corners}{\ulcorner}{\urcorner}
\DeclarePairedDelimiter{\ihom}{[}{]}

\DeclareMathOperator{\Hom}{Hom}
\DeclareMathOperator{\Mor}{Mor}
\DeclareMathOperator{\dom}{dom}
\DeclareMathOperator{\cod}{cod}
\DeclareMathOperator{\idy}{idy}
\DeclareMathOperator{\comp}{com}
\DeclareMathOperator*{\colim}{colim}
\DeclareMathOperator{\im}{im}
\DeclareMathOperator{\ob}{Ob}
\DeclareMathOperator{\Tr}{Tr}
\DeclareMathOperator{\el}{El}
\DeclareMathOperator{\votimes}{\varotimes}

\newcommand{\iHom}{\ul{\Hom}}



\newcommand{\const}[1]{\texttt{#1}}%a constant, or named element of a set
\newcommand{\Set}[1]{\mathsf{#1}}%a named set
\newcommand{\ord}[1]{\mathsf{#1}}%an ordinal
\newcommand{\cat}[1]{\mathcal{#1}}%a generic category
\newcommand{\Cat}[1]{\mathbf{#1}}%a named category
\newcommand{\fun}[1]{\mathrm{#1}}%a function
\newcommand{\Fun}[1]{\mathsf{#1}}%a named functor




\newcommand{\id}{\mathrm{id}}
\newcommand{\then}{\mathbin{\fatsemi}}

\newcommand{\cocolon}{:\!}


\newcommand{\iso}{\cong}
\newcommand{\too}{\longrightarrow}
\newcommand{\tto}{\rightrightarrows}
\newcommand{\To}[2][]{\xrightarrow[#1]{\tn{$#2$}}}
\renewcommand{\Mapsto}[1]{\xmapsto{#1}}
\newcommand{\Tto}[3][13pt]{\begin{tikzcd}[sep=#1, cramped, ampersand replacement=\&, text height=1ex, text depth=.3ex]\ar[r, shift left=2pt, "#2"]\ar[r, shift right=2pt, "#3"']\&{}\end{tikzcd}}
\newcommand{\Too}[1]{\xrightarrow{\;\;#1\;\;}}
\newcommand{\from}{\leftarrow}
\newcommand{\ffrom}{\leftleftarrows}
\newcommand{\From}[1]{\xleftarrow{#1}}
\newcommand{\Fromm}[1]{\xleftarrow{\;\;#1\;\;}}
\newcommand{\surj}{\twoheadrightarrow}
\newcommand{\inj}{\rightarrowtail}
\newcommand{\wavyto}{\rightsquigarrow}
\newcommand{\lollipop}{\multimap}
\newcommand{\imp}{\Rightarrow}
\renewcommand{\iff}{\Leftrightarrow}
\newcommand{\down}{\mathbin{\downarrow}}
\newcommand{\fromto}{\leftrightarrows}
\newcommand{\tickar}{\xtickar{}}
\newcommand{\slashar}{\xslashar{}}
\newcommand{\card}{\,^{\#}}


\newcommand{\inv}{^{-1}}
\newcommand{\op}{^\tn{op}}

\newcommand{\tn}[1]{\textnormal{#1}}
\newcommand{\ol}[1]{\overline{#1}}
\newcommand{\ul}[1]{\underline{#1}}
\newcommand{\wt}[1]{\widetilde{#1}}
\newcommand{\wh}[1]{\widehat{#1}}
\newcommand{\wc}[1]{\widecheck{#1}}
\newcommand{\ubar}[1]{\underaccent{\bar}{#1}}

\newcommand{\lin}[1]{\hspace{1pt}\ol{\hspace{-1pt}#1\hspace{-1pt}}\hspace{1pt}}


\newcommand{\bb}{\mathbb{B}}
\newcommand{\cc}{\mathbb{C}}
\newcommand{\nn}{\mathbb{N}}
\newcommand{\pp}{\mathbb{P}}
\newcommand{\qq}{\mathbb{Q}}
\newcommand{\zz}{\mathbb{Z}}
\newcommand{\rr}{\mathbb{R}}


\newcommand{\finset}{\Cat{Fin}}
\newcommand{\smset}{\Cat{Set}}
\newcommand{\smcat}{\Cat{Cat}}
\newcommand{\catsharp}{\Cat{Cat}^{\sharp}}
\newcommand{\ppolyfun}{\mathbb{P}\Cat{olyFun}}
\newcommand{\en}{\Cat{End}}
\newcommand{\org}{\mathbb{O}\Cat{rg}}

\newcommand{\List}{\Fun{list}}
\newcommand{\lott}{\Fun{lott}}
\newcommand{\set}{\tn{-}\Cat{Set}}




\newcommand{\yon}{{\mathcal{y}}}
\newcommand{\poly}{\Cat{Poly}}
\newcommand{\Span}{\Cat{Span}}
\newcommand{\rect}{\Set{Rect}}
\newcommand{\polycart}{\poly^{\tn{cart}}}
\newcommand{\ppoly}{\mathbb{P}\Cat{oly}}
\newcommand{\0}{\textsf{0}}
\newcommand{\1}{\tn{\textsf{1}}}
\newcommand{\tri}{\mathbin{\triangleleft}}
\newcommand{\triright}{\mathbin{\triangleright}}
\newcommand{\tripow}[1]{^{\tri #1}}
\newcommand{\indep}{\Fun{Indep}}
\newcommand{\duoid}{\Fun{Duoid}}
\newcommand{\jump}{\pi}
\newcommand{\jumpmap}{\lin{\jump}}
\newcommand{\founds}{\Yleft}
\newcommand{\cofree}{\mathfrak{c}}
\newcommand{\free}{\mathfrak{m}}
\newcommand{\uu}{\List}

% lenses
\newcommand{\biglens}[2]{
     \begin{bmatrix}{\vphantom{f_f^f}#2} \\ {\vphantom{f_f^f}#1} \end{bmatrix}
}
\newcommand{\littlelens}[2]{
     \begin{bsmallmatrix}{\vphantom{f}#2} \\ {\vphantom{f}#1} \end{bsmallmatrix}
}
\newcommand{\lens}[2]{
  \relax\if@display
     \biglens{#1}{#2}
  \else
     \littlelens{#1}{#2}
  \fi
}

\newcommand{\indexcoclscale}[1]{\scalebox{.7}{#1}}
\newcommand{\cocl}[1]{
	\scriptsize\overset{\,\indexcoclscale{$#1$}}{\frown}\normalsize
}
\newcommand{\hyper}[1]{
	\begin{tikzpicture}[y=.5cm, font=\scriptsize, baseline=(base)]
		\node[rotate=-15] (ar) {$\nearrow$};
		\coordinate[below=3pt] (base) at (ar);
		\node[above right=-2pt and 1pt of ar.west] (f) {\indexcoclscale{$#1$}};
	\end{tikzpicture}
}

\newcommand{\othis}[1]{\tikz[baseline=(char.base)]{
            \node[shape=circle,draw,inner sep=1pt] (char) {\tiny #1};}}
\newcommand{\bang}{\,\mathbin{!}\,}
\newcommand{\obang}{\mathbin{\othis{!}}}

\newcommand{\hh}[2][]{#1 \tn{#2} #1}
\newcommand{\qqand}{\hh[\qquad]{and}}
\newcommand{\qand}{\hh[\quad]{and}}
\renewcommand{\iff}[1][\;\;]{#1\Leftrightarrow#1}
\newcommand{\ifff}[1][\;\;]{#1\xLeftrightarrow{\quad}#1}
\newcommand{\hi}[4][]{#1 #2 \tn{\textit{#4}} #3}
\newcommand{\where}[1][,]{\hi[#1]{\qquad}{\quad}{where}}
\newcommand{\qimplies}{\hh[\quad]{$\implies$}}
\newcommand{\qqor}{\hh[\qquad]{or}}

\newcommand{\coto}{\nrightarrow}
\newcommand{\cofun}{{\raisebox{2pt}{\resizebox{2.5pt}{2.5pt}{$\setminus$}}}}

\newcommand{\coalg}{\tn{-}\Cat{Coalg}}
\newcommand{\ext}{\fun{Ext}}

\newcommand{\bic}[2]{{}_{#1}\Cat{Comod}_{#2}}


\newcommand{\thanksAFOSR}[1]{This material is based upon work supported by the Air Force Office of Scientific Research under award numbers #1}

% ---- Changeable document parameters ---- %

\linespread{1.1}
\allowdisplaybreaks
\setsecnumdepth{section}
\settocdepth{section}
\setlength{\parindent}{15pt}
\setcounter{tocdepth}{1}



%--------------- Document ---------------%
\begin{document}

\title{Dynamic task delegation for hierarchical agents}

\author{
	Sophie Libkind\and
	David I. Spivak
}

%\date{Last updated: \today}

\maketitle

\begin{abstract}

\end{abstract}

\chapter{Introduction}

An agent is given a \emph{task}, and their job is to deliver an \emph{outcome}. They begin by making a plan: invoke some subordinate agents and hand each of them a task of their own, have the resulting outcomes determine a new bunch of subordinate agents to hand different tasks to, and so on, until finally after some finite amount of time, an outcome is returned to the agent. The agent can learn from whatever is delivered, so that the next time they're given the same task or a similar one, they can make a different plan. This same story can take place at any lower (or higher) level in the same way.

We can move from this natural language description of agents and subagents to a mathematical one, using the framework of polynomial functors. While polynomial functors are defined as ``coproducts of representables $\smset\to\smset$'', we will think of them as task-solution interfaces.
\[
\sum_{T:\text{task}}\yon^{\text{Outcome}[T]}
\]
We intuitively think of tasks like ``purchase an airline ticket to Oakland'', for which an outcome is a certain ticket (or a failure to find one). But one can formalize the notion of task as a type $T$ (e.g.\ $T$=``a prime number $n\geq10^{(10^{10})}$ such that $n+2$ is also prime''), and formalize its outcomes as the terms of that type. The polynomial $p=\sum_{i:I}\yon^{p[i]}$ is an interface for agents that can be given any task $i$ from a set $I$ and in that case can deliver outcomes from the set $p[i]$.

A morphism $\varphi\colon p\to q$ of polynomials can be represented cleanly in dependent type theory: given another polynomial $q=\sum_{j:J}\yon^{q[j]}$, a natural transformation between them has type
\[
\poly(p,q)\coloneqq\prod_{i:I}\sum_{j:J}\prod_{e:q[j]}\sum_{d:p[i]}1.
\]
We can think of this as a \emph{task delegation}, which is a two-step process: 
\begin{enumerate}
\item for every task $i$ that $p$ can perform, it \emph{exports} a task $j$ that $q$ can perform, and
\item for every outcome $b:q[j]$ that $q$ can deliver, it \emph{imports} an outcome that $p$ can deliver.
\end{enumerate}

In this paper, we consider a more general sort of task delegation by invoking two additional notions: a monoidal structure $\vee$ (read ``or'') and the free monad construction $\free_-$. The monoidal structure allows for the possibility of multiple agents acting simultaneously, and the free monad allows for the possibility of a multi-step process to take place before an outcome is returned. In general, we will see that a task in $\free_p$ is a finite-depth tree---or flowchart---of tasks from $p$. 

For example, consider the polynomial $\yon^\nn$; it has only one task, for which an outcome is any natural number. A map $\yon^\nn\to\free_{\yon^\nn\vee\yon^\nn}$ delegates the task to two subagents of the same sort. Such a map might send the unique task to the two-step process that first asks each subagent for a natural number, then asks whoever had the bigger number (or the first subagent if the numbers were equal) to choose a second number, and finally returns the sum to the original agent. We will see that Huffman coding is another example.

The resulting language can be seen as an accounting system for agents, each of which recursively calls subagents to perform tasks, all in finite time, and for how agents can \emph{learn} from the outcomes. Mathematically, we structure this as a generalization of \emph{dynamic monoidal category}, in the sense of \cite{shapiro2022dynamic}, of which the gradient descent and backpropagation pattern in deep learning is also an example. That paper discussed various examples of categorical structures (categories, monoidal categories, multicategories, etc.) enriched in $\org$, a variant of which was introduced in \cite[Def 2.19]{spivak2021learnersv1}. 

In this paper, we show that the free monad monad $\free_-\colon\poly\to\poly$ extends to a monad on $\org$, one which is furthermore lax monoidal with respect to $\vee$. The Kleisli double category $\org_\free$ serves as a base of enrichment for a more flexible kind of dynamic categorical structures, ones where the subordinate dynamics can occur at \emph{faster timescales} than the higher-level dynamics does.

We go only two steps further. First we describe a dynamic operad that we denote $\org^\cofree$, corresponding to the cofree comonad comonad $\cofree_-\colon\poly\to\poly$. And second, we provide a double functor $[-,t]\colon\org_\free\op\to\org^\cofree$ for any polynomial monad $t$, which ``converts patterns to the matter they run on'', in the sense of \cite{libkind2024pattern}. Taking $t=\yon$, a hierarchical agent which adds up pairs of numbers that its subordinates choose would be sent to a machine that takes streams and adds up consecutive pairs of numbers in the corresponding way. Taking $t=\lott$ to be the monad corresponding to finite-sample-space random variables, the same is true except that an element of randomness is introduced at each stage. All this will be made explicit in the text below.

\section*{Plan of the paper}

\section*{Acknowledgments}
We appreciate helpful conversations with C.B. Aberl\'e, who suggested our stream-processing example, \cref{**}.

\thanksAFOSR{FA9550-23-1-0376}.



\printbibliography
\end{document}